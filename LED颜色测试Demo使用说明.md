# LED颜色测试Demo使用说明

## 功能概述

这个测试Demo实现了ESP32基站自动扫描并连接智能标签设备，然后循环发送LED颜色变化指令的功能。

### 主要功能

1. **自动扫描设备**：系统启动后自动扫描附近的智能标签设备
2. **自动连接**：发现智能标签后自动发起连接
3. **LED颜色循环**：连接成功后循环改变LED颜色
4. **状态监控**：实时显示系统状态和连接信息

### 颜色循环顺序

Demo按以下顺序循环改变LED颜色：
1. 🔴 红色 (3秒)
2. 🟢 绿色 (3秒)
3. 🔵 蓝色 (3秒)
4. 🟡 黄色 (3秒)
5. 🟣 紫色 (3秒)
6. 🔷 青色 (3秒)
7. ⚪ 白色 (3秒)
8. ⚫ 关闭 (3秒)

然后重复上述循环。

## 使用方法

### 1. 准备工作

确保你的ESP32开发环境已经配置好：
- ESP-IDF v5.4.1 或更高版本
- 项目依赖的所有组件已正确配置

### 2. 编译选项

有两种方式运行这个Demo：

#### 方式1：替换main.c文件

将`main/led_color_test_demo.c`重命名为`main.c`，替换原有的主程序：

```bash
# 备份原main.c文件
mv main/main.c main/main.c.backup

# 使用demo文件作为主程序
mv main/led_color_test_demo.c main/main.c
```

#### 方式2：修改CMakeLists.txt

在`main/CMakeLists.txt`中修改源文件列表：

```cmake
# 在main/CMakeLists.txt中修改SRCS
set(SRCS 
    # "main.c"  # 注释掉原main.c
    "led_color_test_demo.c"  # 使用demo文件
)

idf_component_register(SRCS ${SRCS}
                      INCLUDE_DIRS "."
                      REQUIRES bluetooth_manager led_controller mqtt_manager ota_manager system_config)
```

### 3. 编译和烧录

```bash
# 编译项目
idf.py build

# 烧录到ESP32
idf.py flash

# 查看串口日志
idf.py monitor
```

### 4. 运行效果

#### 启动日志
```
🚀 LED颜色测试Demo启动
🎨 演示功能：循环改变智能标签LED颜色
🔄 颜色顺序：红->绿->蓝->黄->紫->青->白->关闭
✅ NVS Flash 初始化完成
✅ 系统配置初始化完成
...
```

#### 扫描和连接日志
```
🔍 开始扫描智能标签设备...
✅ 扫描已启动
📡 [扫描发现] SmartTag_001
📍 MAC地址: 01:a1:26:66:bf:01
📶 信号强度: -65 dBm
🏷️ 智能标签: 是
🔗 发现智能标签，开始连接...
✅ 连接请求已发送
```

#### 连接成功和颜色循环日志
```
📱 设备 1 状态变化: 断开 -> 连接中
🔄 设备 1 正在连接...
📱 设备 1 状态变化: 连接中 -> 已连接
🎉 设备 1 连接成功！开始LED颜色循环演示
🔧 发送初始化命令: 关闭LED
🎨 [1/8] 发送颜色命令: RED
✅ 颜色命令发送成功: RED
🎨 [2/8] 发送颜色命令: GREEN
✅ 颜色命令发送成功: GREEN
...
```

#### 状态监控日志
```
📊 === 演示状态 ===
🔋 剩余内存: 182456 bytes
📱 连接设备: 1
🎨 演示状态: 运行中
🎯 当前颜色: BLUE (3/8)
🔗 已连接设备数: 1
==================
```

## 关键特性

### 1. 自动重连
- 如果设备断开连接，系统会自动重新扫描并连接
- 支持设备状态实时监控

### 2. 错误处理
- 命令发送失败时会记录错误日志
- 连接失败时会重试连接
- 设备离线时会停止颜色循环

### 3. 任务管理
- **扫描任务**：负责周期性扫描设备
- **颜色循环任务**：负责LED颜色变化
- **状态显示任务**：定期显示系统状态

### 4. 日志特色
- 使用Emoji表情符号增强可读性
- 中文提示信息，便于理解
- 详细的状态和错误信息

## 故障排除

### 1. 扫描不到设备
- 检查智能标签是否开启并处于广播状态
- 确认设备距离在BLE通信范围内（通常10米内）
- 检查设备名称是否符合预期（包含"SmartTag"等关键词）

### 2. 连接失败
- 检查设备是否已被其他设备连接
- 确认BLE协议栈配置正确
- 检查设备地址类型是否匹配

### 3. 颜色变化无效果
- 确认智能标签支持相应的颜色命令
- 检查GATT服务和特征值是否正确配置
- 查看设备响应日志，确认命令是否被正确处理

## 自定义修改

### 1. 修改颜色序列
在`led_color_test_demo.c`中修改`color_sequence`数组：

```c
static const led_color_t color_sequence[] = {
    LED_COLOR_RED,      // 红色
    LED_COLOR_GREEN,    // 绿色
    LED_COLOR_BLUE,     // 蓝色
    // 添加或删除颜色...
};
```

### 2. 修改时间间隔
修改颜色持续时间和切换间隔：

```c
/* 颜色持续时间（毫秒） */
.param2 = 3000,  // 改为你想要的时间

/* 切换间隔（毫秒） */
vTaskDelay(pdMS_TO_TICKS(3500));  // 改为你想要的间隔
```

### 3. 修改扫描间隔
修改扫描任务中的扫描间隔：

```c
/* 扫描间隔（毫秒） */
vTaskDelay(pdMS_TO_TICKS(30000));  // 改为你想要的间隔
```

## 技术架构

### 系统架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   扫描任务       │    │   颜色循环任务   │    │   状态显示任务   │
│   demo_scan     │    │   led_cycle     │    │   demo_status   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                ┌─────────────────┴─────────────────┐
                │        蓝牙管理器                  │
                │    bluetooth_manager              │
                └───────────────────────────────────┘
                                 │
                ┌─────────────────┴─────────────────┐
                │          NimBLE协议栈              │
                │        BLE Central模式            │
                └───────────────────────────────────┘
```

### 数据流
```
[扫描] → [发现设备] → [连接] → [GATT发现] → [命令发送] → [响应处理]
   ↑                                                            │
   └────────────────── [断开检测] ←──────────────────────────────┘
```

这个Demo提供了一个完整的BLE设备控制示例，可以作为更复杂应用的基础。 